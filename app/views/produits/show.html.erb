<h1 class="text-3xl font-bold text-center my-6">D√©tails du Produit</h1>

<div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">

  <% if @produit.photos_url.present? %>
    <ul class="space-y-2 mt-4">
      <% @produit.photos_url.split(",").map(&:strip).each_with_index do |url, i| %>
        <% transformed_url = if url.include?("drive.google.com/file/d/")
            "https://drive.google.com/uc?id=#{url.match(/\/d\/(.*?)\//)[1]}"
          else
            url
          end rescue url %>
        <li>
          <%= link_to "üì∑ Photo #{i + 1}", transformed_url, target: "_blank", class: "text-blue-600 underline hover:text-blue-800" %>
        </li>
      <% end %>
    </ul>
  <% end %>



  <!-- üìå Informations g√©n√©rales -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <h2 class="text-xl font-semibold mb-2"><%= @produit.nom %></h2>
      <p class="text-gray-600"><strong>ID :</strong> <%= @produit.id %></p>
      <p class="text-gray-600"><strong>Cat√©gorie :</strong> <%= @produit.categorie %></p>
      <p class="text-gray-600"><strong>√âtat :</strong> <%= @produit.etat.humanize %></p>
      <p class="text-gray-600"><strong>Stock :</strong> <%= @produit.stock > 0 ? @produit.stock : "Rupture" %></p>
      <p class="text-gray-600"><strong>Prix de vente :</strong>
                <% if @produit.en_promo? && @produit.prix_promo.present? %>
                  <span class="relative inline-block text-base text-gray-600 font-medium">
                    <span class="inline-block"><%= number_to_currency(@produit.prix) %></span>
                    <span style="position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background-color: red; transform: rotate(-15deg); transform-origin: left center;"></span>
                  </span>
                  <span class="ml-2 text-red-600 font-bold text-xl">
                    <%= number_to_currency(@produit.prix_promo) %>
                  </span>
                <% else %>
                  <%= number_to_currency(@produit.prix) %>
                <% end %>
      </p>
    </div>

    <!-- üìå Affichage conditionnel selon l'√©tat du produit -->
    <% if @produit.etat == "neuf" || @produit.etat == "occasion" %>
      <div>
        <h3 class="text-lg font-semibold mb-2">Informations sur l'achat</h3>
        <p class="text-gray-600"><strong>Prix d'achat (remise incluse) :</strong> <%= number_to_currency(@produit.prix_achat, unit: "‚Ç¨") %></p>
        <p class="text-gray-600"><strong>Date d'achat :</strong> <%= @produit.date_achat.present? ? @produit.date_achat.strftime("%d/%m/%Y") : "Non renseign√©e" %></p>
        <p class="text-gray-600"><strong>Fournisseur :</strong>
          <%= @produit.fournisseur.present? ? link_to(@produit.fournisseur.nom, fournisseur_path(@produit.fournisseur), class: "text-blue-500 hover:underline") : "Non renseign√©" %>
        </p>
        <p class="text-gray-600"><strong>Code Fournisseur :</strong> <%= @produit.code_fournisseur.presence || "Non renseign√©" %></p>
        <% if @produit.remise_fournisseur? %>
          <p class="mt-2 text-sm text-red-600 font-semibold">
            ‚úÖ Remise fournisseur : <%= @produit.taux_remise_fournisseur %>%<br>
          </p>
        <% else %>
          <p class="mt-2 text-sm text-gray-600">
            Aucune remise fournisseur appliqu√©e.
          </p>
        <% end %>

      </div>

    <% elsif @produit.etat == "depot_vente" %>
      <div>
        <h3 class="text-lg font-semibold mb-2">D√©tails du D√©p√¥t-Vente</h3>
        <p class="text-gray-600"><strong>Prix du d√©posant :</strong> <%= number_to_currency(@produit.prix_deposant, unit: "‚Ç¨") %></p>
        <p class="text-gray-600"><strong>Date de d√©p√¥t :</strong> <%= @produit.date_depot.present? ? @produit.date_depot.strftime("%d/%m/%Y") : "Non renseign√©e" %></p>
        <p class="text-gray-600"><strong>Nom du d√©posant :</strong>
          <%= @produit.client.present? ? link_to(@produit.client.nom, client_path(@produit.client), class: "text-blue-500 hover:underline") : "Non renseign√©" %>
        </p>
        <% if @produit.observation.present? %>
          <p class="text-gray-600"><strong>Observation :</strong> <%= @produit.observation %></p>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- üìå Code-barre -->
  <div class="mt-4">
    <p class="text-gray-600"><strong>Code-barre :</strong> <%= @produit.code_barre.presence || "Non g√©n√©r√©" %></p>
    <p class="text-gray-600"><strong>Impression code-barre :</strong> <%= @produit.impression_code_barre? ? "Oui" : "Non" %></p>
  </div>

  <h2 class="text-xl font-bold mt-8 mb-3">üì¶ R√©assorts</h2>

  <% if @produit.reassorts.any? %>
    <table class="min-w-full text-sm border rounded shadow">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="px-3 py-2 text-left">Date</th>
          <th class="px-3 py-2 text-left">Quantit√©</th>
          <th class="px-3 py-2 text-left">Prix achat</th>
          <th class="px-3 py-2 text-left">Remise</th>
          <th class="px-3 py-2 text-left">Taux (%)</th>
          <th class="px-3 py-2 text-left">√âtiquettes</th>
        </tr>
      </thead>
      <tbody>
        <% @produit.reassorts.order(date: :desc).each do |reassort| %>
          <tr class="border-t">
            <td class="px-3 py-2"><%= l reassort.date %></td>
            <td class="px-3 py-2"><%= reassort.quantite %></td>
            <td class="px-3 py-2"><%= number_to_currency(reassort.prix_achat) %></td>
            <td class="px-3 py-2"><%= reassort.remise ? "‚úÖ" : "‚Äî" %></td>
            <td class="px-3 py-2"><%= reassort.remise ? "#{reassort.taux_remise} %" : "‚Äî" %></td>
            <td class="px-3 py-2">
              <%= button_to "üñ®Ô∏è", imprimer_etiquettes_produit_reassort_path(@produit, reassort),
                  method: :post,
                  class: "text-sm bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700",
                  data: { turbo_confirm: "Imprimer #{reassort.quantite} √©tiquette(s) ?" } %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p class="text-gray-500 italic">Aucun r√©assort enregistr√© pour ce produit.</p>
  <% end %>


  <!-- üìå Actions -->
  <div class="mt-6">
    <%= link_to "Modifier", edit_produit_path(@produit), class: "text-yellow-500 hover:underline" %> |
    <%= link_to "Retour", produits_path, class: "text-blue-500 hover:underline" %> |
    <%= link_to "‚ûï Ajouter un r√©assort", new_produit_reassort_path(@produit),
            class: "px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700" %>
  </div>
  <div class="mt-6">
    <%= button_to "Envoyer sur Shopify", envoyer_shopify_produit_path(@produit), method: :post, data: { confirm: "Envoyer ce produit sur Shopify ?" }, class: "bg-green-600 text-white rounded px-4 py-2" %>
  </div>
</div>