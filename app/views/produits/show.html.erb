<h1 class="text-3xl font-bold text-center my-6">D√©tails du Produit</h1>

<div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">

  <!-- üìå Affichage de l'image principale -->
  <div class="mb-4">
    <% if @produit.photos.attached? %>
      <div class="grid grid-cols-2 gap-2">
        <% @produit.photos.each do |photo| %>
          <%= image_tag photo.variant(resize_to_limit: [300, 300]), class: "rounded shadow" %>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- üìå Informations g√©n√©rales -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <h2 class="text-xl font-semibold mb-2"><%= @produit.nom %></h2>
      <p class="text-gray-600"><strong>ID :</strong> <%= @produit.id %></p>
      <p class="text-gray-600"><strong>Cat√©gorie :</strong> <%= @produit.categorie %></p>
      <p class="text-gray-600"><strong>√âtat :</strong> <%= @produit.etat.humanize %></p>
      <p class="text-gray-600"><strong>Stock :</strong> <%= @produit.stock > 0 ? @produit.stock : "Rupture" %></p>
      <p class="text-gray-600"><strong>Prix de vente :</strong> <%= number_to_currency(@produit.prix, unit: "‚Ç¨") %></p>
    </div>

    <!-- üìå Affichage conditionnel selon l'√©tat du produit -->
    <% if @produit.etat == "neuf" || @produit.etat == "occasion" %>
      <div>
        <h3 class="text-lg font-semibold mb-2">Informations sur l'achat</h3>
        <p class="text-gray-600"><strong>Prix d'achat (remise incluse) :</strong> <%= number_to_currency(@produit.prix_achat, unit: "‚Ç¨") %></p>
        <p class="text-gray-600"><strong>Date d'achat :</strong> <%= @produit.date_achat.present? ? @produit.date_achat.strftime("%d/%m/%Y") : "Non renseign√©e" %></p>
        <p class="text-gray-600"><strong>Fournisseur :</strong>
          <%= @produit.fournisseur.present? ? link_to(@produit.fournisseur.nom, fournisseur_path(@produit.fournisseur), class: "text-blue-500 hover:underline") : "Non renseign√©" %>
        </p>
        <p class="text-gray-600"><strong>Code Fournisseur :</strong> <%= @produit.code_fournisseur.presence || "Non renseign√©" %></p>
        <% if @produit.remise_fournisseur? %>
          <p class="mt-2 text-sm text-red-600 font-semibold">
            ‚úÖ Remise fournisseur : <%= @produit.taux_remise_fournisseur %>%<br>
          </p>
        <% else %>
          <p class="mt-2 text-sm text-gray-600">
            Aucune remise fournisseur appliqu√©e.
          </p>
        <% end %>

      </div>

    <% elsif @produit.etat == "depot_vente" %>
      <div>
        <h3 class="text-lg font-semibold mb-2">D√©tails du D√©p√¥t-Vente</h3>
        <p class="text-gray-600"><strong>Prix du d√©posant :</strong> <%= number_to_currency(@produit.prix_deposant, unit: "‚Ç¨") %></p>
        <p class="text-gray-600"><strong>Date de d√©p√¥t :</strong> <%= @produit.date_depot.present? ? @produit.date_depot.strftime("%d/%m/%Y") : "Non renseign√©e" %></p>
        <p class="text-gray-600"><strong>Nom du d√©posant :</strong>
          <%= @produit.client.present? ? link_to(@produit.client.nom, client_path(@produit.client), class: "text-blue-500 hover:underline") : "Non renseign√©" %>
        </p>
        <% if @produit.observation.present? %>
          <p class="text-gray-600"><strong>Observation :</strong> <%= @produit.observation %></p>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- üìå Code-barre -->
  <div class="mt-4">
    <p class="text-gray-600"><strong>Code-barre :</strong> <%= @produit.code_barre.presence || "Non g√©n√©r√©" %></p>
    <p class="text-gray-600"><strong>Impression code-barre :</strong> <%= @produit.impression_code_barre? ? "Oui" : "Non" %></p>
  </div>

  <!-- üìå Autres images -->
  <% if @produit.images.attached? && @produit.images.count > 1 %>
    <div class="mt-6">
      <h3 class="text-lg font-semibold">Autres images</h3>
      <div class="grid grid-cols-3 gap-4 mt-2">
        <% @produit.images.each_with_index do |image, index| %>
          <% next if index == 0 %> <!-- On ignore la premi√®re image d√©j√† affich√©e -->
          <%= image_tag image.variant(resize_to_limit: [150, 150]), class: "rounded shadow" %>
        <% end %>
      </div>
    </div>
  <% end %>

  <h2 class="text-xl font-bold mt-8 mb-3">üì¶ R√©assorts</h2>

  <% if @produit.reassorts.any? %>
    <table class="min-w-full text-sm border rounded shadow">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="px-3 py-2 text-left">Date</th>
          <th class="px-3 py-2 text-left">Quantit√©</th>
          <th class="px-3 py-2 text-left">Prix achat</th>
          <th class="px-3 py-2 text-left">Remise</th>
          <th class="px-3 py-2 text-left">Taux (%)</th>
          <th class="px-3 py-2 text-left">√âtiquettes</th>
        </tr>
      </thead>
      <tbody>
        <% @produit.reassorts.order(date: :desc).each do |reassort| %>
          <tr class="border-t">
            <td class="px-3 py-2"><%= l reassort.date %></td>
            <td class="px-3 py-2"><%= reassort.quantite %></td>
            <td class="px-3 py-2"><%= number_to_currency(reassort.prix_achat) %></td>
            <td class="px-3 py-2"><%= reassort.remise ? "‚úÖ" : "‚Äî" %></td>
            <td class="px-3 py-2"><%= reassort.remise ? "#{reassort.taux_remise} %" : "‚Äî" %></td>
            <td class="px-3 py-2">
              <%= button_to "üñ®Ô∏è", imprimer_etiquettes_produit_reassort_path(@produit, reassort),
                  method: :post,
                  class: "text-sm bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700",
                  data: { turbo_confirm: "Imprimer #{reassort.quantite} √©tiquette(s) ?" } %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p class="text-gray-500 italic">Aucun r√©assort enregistr√© pour ce produit.</p>
  <% end %>


  <!-- üìå Actions -->
  <div class="mt-6">
    <%= link_to "Modifier", edit_produit_path(@produit), class: "text-yellow-500 hover:underline" %> |
    <%= link_to "Retour", produits_path, class: "text-blue-500 hover:underline" %> |
    <%= link_to "‚ûï Ajouter un r√©assort", new_produit_reassort_path(@produit),
            class: "px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700" %>
  </div>
</div>
