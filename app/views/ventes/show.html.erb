<div class="max-w-4xl mx-auto bg-white shadow rounded p-6">
  <h1 class="text-2xl font-bold mb-4">🧾 Détail de la vente n°<%= @vente.id %></h1>
  <div class="mb-4 text-gray-700">
    <p><strong>ID Vente :</strong> <%= @vente.id %></p>
    <p><strong>Date :</strong> <%= l(@vente.date_vente || @vente.created_at, format: :long) %></p>
    <p><strong>Cliente :</strong> <%= @vente.client&.nom || "Sans cliente" %></p>
    <p><strong>Mode de paiement :</strong> <%= @vente.mode_paiement || "Non précisé" %></p>
    <p><strong>Total brut :</strong> <%= number_to_currency(@vente.total_brut) %></p>
    <p><strong>Total net (après remises) :</strong> <%= number_to_currency(@vente.total_net) %></p>
  </div>

  <h2 class="text-xl font-semibold mt-6 mb-2">🛍 Produits vendus</h2>
  <table class="w-full text-sm border-collapse">
    <thead class="bg-gray-100 text-gray-700">
      <tr>
        <th class="text-left px-3 py-2">Produit ID</th>
        <th class="text-left px-3 py-2">Nom</th>
        <th class="text-left px-3 py-2">Code-barres</th>
        <th class="text-right px-3 py-2">Quantité</th>
        <th class="text-right px-3 py-2">Prix unitaire</th>
        <th class="text-right px-3 py-2">Nom du déposant</th>
        <th class="text-right px-3 py-2">Prix déposant</th>
        <th class="text-right px-3 py-2">Total</th>
      </tr>
    </thead>
    <tbody>
      <% @vente.ventes_produits.includes(:produit).each do |vp| %>
        <tr class="border-b">
          <td class="px-3 py-2"><%= vp.produit.id %></td>
          <td class="px-3 py-2"><%= vp.produit.nom %></td>
          <td class="px-3 py-2"><%= vp.produit.code_barre %></td>
          <td class="px-3 py-2 text-right"><%= vp.quantite %></td>
          <td class="px-3 py-2 text-right"><%= number_to_currency(vp.prix_unitaire) %></td>
          <td class="px-3 py-2">
            <% if vp.produit.client.present? %>
              <%= link_to "#{vp.produit.client.prenom} #{vp.produit.client.nom}", client_path(vp.produit.client), class: "text-blue-600 hover:underline" %>
            <% else %>
              -
            <% end %>
          </td>
          <td class="px-3 py-2"><%= number_to_currency(vp.produit.prix_deposant) %></td>
          <% total_brut = vp.prix_unitaire * vp.quantite %>
          <% remise_pct = vp.remise.to_d %>
          <% remise_euros = (total_brut * (remise_pct / 100)).round(2) %>
          <% total_net = (total_brut - remise_euros).round(2) %>
          <td class="px-3 py-2 text-right">
            <div><strong><%= number_to_currency(total_net) %></strong></div>
            <div class="text-xs text-gray-500">(- <%= number_to_currency(remise_euros) %> | <%= remise_pct.to_i %>%)</div>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <div class="mt-6">
    <%= link_to "← Retour à la liste", ventes_path, class: "text-blue-600 hover:underline" %>
  </div>
</div>
